<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JS-Interpreter JSON Demo</title>
  <link href="style.css" rel="stylesheet" type="text/css">
  <script src="../acorn.js"></script>
  <script src="../interpreter.js"></script>
  <script>
    // Extend Interpreter obj
    Interpreter.prototype.getGlobalScope = function() {
      for (var i = this.stateStack.length - 1; i >= 0 ; i--) {
        if (this.stateStack[i].scope) {
          return this.stateStack[i].scope;
        }
      }
      throw 'No scope found.';
    };
    Interpreter.prototype.stepThread = function() {
      if (this.step() && this.stateStack.length > 0) {
        if (this.parentInterpreter) {
          if (this.stateStack[0].node.type === 'ExpressionStatement' && !this.stateStack[0].done) {
            // Copy global scope to local scope
            for (var key in this.parentInterpreter.getGlobalScope().properties) {
              this.getGlobalScope().properties[key] = this.parentInterpreter.getGlobalScope().properties[key];
            }
          } else if (this.stateStack[0].node.type === 'AssignmentExpression' &&
                     this.stateStack[0].doneLeft &&
                     this.stateStack[0].doneRight) {
            // Copy local scope to global scope
            // Assumes variable declaration is done only in global scope
            this.parentInterpreter.getGlobalScope().properties[this.stateStack[0].leftSide.data] = this.stateStack[0].value;
          }
        }
        return true;
      } else {
        return false;
      }
    };

    var code;
    var self = { interpreter: null };

    function initApi(interpreter, scope) {
      // var wrapper = function(secs) {
      //   secs = secs ? secs.toNumber() * 1000: 0;
      //   return interpreter.createPrimitive(Meteor._sleepForMs(secs));
      // };
      // interpreter.setProperty(scope, 'sleep',
      //     interpreter.createNativeFunction(wrapper));

      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(console.log(text));
      };
      interpreter.setProperty(scope, 'print',
          interpreter.createNativeFunction(wrapper));

      function createThreads(interpreters) {
        function runThread(interp) {
          return new Promise(function(resolve, reject) {
            function nextStep() {
              if (interp.stepThread()) {
                // Meteor.setTimeout(nextStep, 0);
                setTimeout(nextStep, 0);
              } else {
                resolve(true);
              }
            }
            nextStep(interp);
          });
        }
        // return Meteor.wrapAsync(function(callback) {
        //   Promise.all(interpreters.map(runThread)).then(function(results) {
        //     console.log("wait_for_all results:", results);
        //     callback(null, null);
        //   }).catch(function(err) {
        //     console.error("wait_for_all error:", err);
        //     callback(null, null);
        //   });
        // });
        return function() {
          for (var i = 0; i < interpreters.length; i++) {
            runThread(interpreters[i]);
          }
        };
      }

      interpreter.setProperty(scope, 'wait_for_all', interpreter.createNativeFunction(
        function(branches_obj) {
          // self.mostRecentPrimitive = {
          //   name: 'endProgram',
          //   args: []
          // };
          var branches = [];
          var branchCode = [];
          var branchInterpreters = [];
          for (var i = 0; i < branches_obj.length; i++) {
            var branch = branches_obj.properties[i];
            branches.push(branch);
            branchCode.push(code.substring(branches[i].node.start + 12, branches[i].node.end - 3));
            branchInterpreters.push(new Interpreter(branchCode[i], initApi));
            branchInterpreters[i].parentInterpreter = self.interpreter;
          }
          return interpreter.createPrimitive(createThreads(branchInterpreters)());
        }
      ));
    }

    function parseButton() {
      code = document.getElementById('code').value;
      self.interpreter = new Interpreter(code, initApi);
      disable('');
    }

    function stepButton() {
      if (self.interpreter.stateStack[0]) {
        var node = self.interpreter.stateStack[0].node;
        var start = node.start;
        var end = node.end;
      } else {
        var start = 0;
        var end = 0;
      }
      createSelection(start, end);
      try {
        var ok = self.interpreter.step();
      } finally {
        if (!ok) {
          disable('disabled');
        }
      }
    }

    function runButton() {
      disable('disabled');
      self.interpreter.run()
    }

    function disable(disabled) {
      document.getElementById('stepButton').disabled = disabled;
      document.getElementById('runButton').disabled = disabled;
    }

    function createSelection(start, end) {
      var field = document.getElementById('code')
      if (field.createTextRange) {
        var selRange = field.createTextRange();
        selRange.collapse(true);
        selRange.moveStart('character', start);
        selRange.moveEnd('character', end);
        selRange.select();
      } else if (field.setSelectionRange) {
        field.setSelectionRange(start, end);
      } else if (field.selectionStart) {
        field.selectionStart = start;
        field.selectionEnd = end;
      }
      field.focus();
    }
  </script>
</head>
<body>
  <h1>JS-Interpreter JSON Demo</h1>

  <p>Moving primitive values (numbers, strings, booleans, etc) in and out of the
  interpreter is easy, just use <code>interpreter.createPrimitive(value)</code>
  to wrap a JS primitive into an interpreter's primitive, and
  <code>value.valueOf()</code> to extract a JS primitive from an interpreter's
  primitive (or use <code>value.toString()</code>,
  <code>value.toNumber()</code>, or <code>value.toBoolean()</code> to coerce
  specific types).</p>

  <p>By contrast, moving objects in and out of the interpreter is not advised.
  Having two JavaScript environments with handles to the same mutable JS object
  would be problematic.  As a result, the best way to move objects (including
  arrays) in and out of the interpreter is to serialize and deserialize them
  as JSON.  Below is a minimal example of round-tripping a JSON object though
  the interperter and back.</p>

  <p>Click <em>Parse</em>, then either click <em>Step</em> repeatedly,
  or click <em>Run</em> once.  Open your browser's console for errors.</p>

  <p><textarea id="code" style="height: 10em;">
// Capturing variable test 2
var a = 1;
var set_a_to_2 = function(a) {
    a = 2;
};
// set_a_to_2();
// print("a = " + a + " // 1");
wait_for_all([function() {
    set_a_to_2(a);
    print("a = " + a + " // 1");
}]);
print("a = " + a + " // 1");
</textarea><br>
  <button onclick="parseButton()">Parse</button>
  <button onclick="stepButton()" id="stepButton" disabled="disabled">Step</button>
  <button onclick="runButton()" id="runButton" disabled="disabled">Run</button>
  </p>

  <p>JSON Input: <input id="JSON_input" style="width: 90%" value='{"apollo11":["Neil Armstrong","Buzz Aldrin"],"apollo12":["Pete Conrad","Alan Bean"],"apollo13":[],"apollo14":["Alan Shepard","Edgar Mitchell"],"apollo15":["David Scott","James Irwin"],"apollo16":["John W. Young","Charles Duke"],"apollo17":["Eugene Cernan","Harrison Schmitt"]}'></p>
  <p>JSON Output: <input id="JSON_output" style="width: 90%" readonly="true"></p>

  <p>Back to the <a href="../docs.html">JS-Interpreter documentation</a>.</p>

  <script>
    disable('disabled');
  </script>
</body>
</html>
